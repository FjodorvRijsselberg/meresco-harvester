#!/bin/bash

source /usr/share/seecr-tools/functions.d/svc
source /usr/share/seecr-tools/functions.d/user

DEFAULT_SLEEP=300
DEFAULT_HARVESTER_URL=http://localhost:9080
DEFAULT_CONCURRENCY=1

function show_usage {
    echo "Usage:
    --domain=<string>
       - Name of the domain to harvest
    --harvester-url=${DEFAULT_HARVESTER_URL}
       - Url to retrieve domain information at
    --concurrency=${DEFAULT_CONCURRENCY}
       - How many thread to use at the same time
    --sleep-time=${DEFAULT_SLEEP}
       - Seconds to sleep between harvest runs
"
}

DOMAIN=
HARVESTER_URL=${DEFAULT_HARVESTER_URL}
SLEEP=${DEFAULT_SLEEP}
CONCURRENCY=${DEFAULT_CONCURRENCY}

TEMP=$(getopt \
    --options "" \
    --long domain::,harvester-url::,concurrency::,sleep-time::, \
    -n "$0" -- "$@")

eval set -- "$TEMP"

while true ; do
        case "$1" in
                --domain)
                    case "$2" in
                        "") show_usage ; exit 1 ;;
                        *) DOMAIN=$2 ; shift 2 ;;
                    esac ;;
                --harvester-url)
                    case "$2" in
                        "") show_usage ; exit 1 ;;
                        *) HARVESTER_URL=$2 ; shift 2;;
                    esac ;;
                --concurrency)
                    case "$2" in
                        "") show_usage ; exit 1 ;;
                        *) CONCURRENCY=$2 ; shift 2;;
                    esac ;;
                --sleep-time)
                    case "$2" in
                        "") show_usage ; exit 1 ;;
                        *) SLEEPTIME=$2 ; shift 2;;
                    esac ;;
                --) shift ; break ;;
                *) echo "Unknown option specified." ; exit 1 ;;
        esac
done

if [ -z "${DOMAIN}" ]; then
    show_usage
    exit 1
fi

if [ ! -f /etc/meresco-harvester/install.config ]; then
    echo "Meresco Harvester Install configuration not found."
    exit 1
fi

source /etc/meresco-harvester/install.config
if [ ! -f ${DATAPATH}/harvester-data/${DOMAIN}.domain ]; then
    echo "Domain '${DOMAIN}' not found."
    exit 1
fi

RUN_SCRIPT="
sleep ${SLEEP}

exec setuidgid ${USER} meresco-harvester \\
    --domain=${DOMAIN} \\
    --saharaurl=${HARVESTER_URL} \\
    --concurrency=${CONCURRENCY} \\
    --runOnce \\
    2>&1 \"\$@\"
"
SERVICE_NAME=meresco-harvester-${DOMAIN}
svc_create_service ${USER} $(user_groupname ${USER}) ${SERVICE_DIR} "" ${SERVICE_NAME} "${RUN_SCRIPT}"
svc_prepare_service ${SERVICE_DIR} ${SERVICE_NAME}

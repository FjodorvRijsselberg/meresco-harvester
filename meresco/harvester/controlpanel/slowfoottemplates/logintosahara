<%
from slowfoot import account
from os.path import isfile
f = asform(input)
username = f.username
password = f.password

if not f.username:
  redirect('/')

passwdFile = req.get_options()['usersfile']

domainName = xpathFirst(aslxml(url('/users.xml')).getroot(), '%s/domain/text()' % username)

try:
  account.login(str(username), str(password), passwdFile) 
  session['username'] = str(username)
  if domainName and isfile(filepath('%s.domain' % domainName)):
    session['domain'] = str(domainName)
  else:
    session['domain'] = ''
  session['isAdmin'] = username == 'admin'
  session.save()
  redirect('/')
except account.AccountException, e:
  session['username'] = ''
  session['domain'] = ''
  session['isAdmin'] = False
  session.save()
  redirect(referer.split('?')[0] + '?login=invalid&referer=' + f.referer)
%>

<%
repourl = None
errorCode = ''
type('text/xml; charset=utf-8')
domainId = args.domainId
if args.saharaIdentifier:
  repositoryId, identifier = str(args.saharaIdentifier).split(':',1)
else:
  repositoryId = str(args.repositoryId)
  identifier = str(args.identifier)
if repositoryId and identifier:
  from os.path import isfile
  if isfile(req.document_root() + '/%s.%s.repository'%(domainId,repositoryId)):
    repo = aslxml(url('/xml/%s.%s.repository'%(domainId,repositoryId))).getroot()
    repourl = xpathFirst(repo, 'baseurl/text()')
    metadataPrefix = args.metadataPrefix or xpathFirst(repo, 'metadataPrefix/text()')
    if not repourl:
      errorCode = 'idDoesNotExist'
  else:
    errorCode = 'idDoesNotExist'
else:
  errorCode = 'badArgument'
if not errorCode:
  includeurl = '%s?%s'%(repourl, 
    urlencode({'verb':'GetRecord', 
      'metadataPrefix':metadataPrefix, 
      'identifier':identifier})
  )
  #This hack was introduced by TJ and KVS 2006/06/12
  #it's a workaround for Groningen's server which cannot deal with the
  #"Accept-Encoding: identity" header produced by urllib2 (and standard HTTP)
  #urllib2 is used by the url function
  if 'rug.nl/' in includeurl:
    from urllib import urlopen
    oaigetrecord = aslxml(urlopen(includeurl))
  else:
    oaigetrecord = aslxml(url(includeurl))
  errOAI = xpathFirst(oaigetrecord, '/oai:OAI-PMH/oai:error')
%><?xml version="1.0" encoding="UTF-8"?>
<saharaget xmlns="http://sahara.cq2.org/xsd/saharaget.xsd">
<%
  include('/saharagetTime')
%> 
 <request>
  <verb>GetRecord</verb>
  <domainId><% escape_xml(domainId) %></domainId>
  <saharaIdentifier><% escape_xml(repositoryId) %>:<% escape_xml(identifier) %></saharaIdentifier>
 </request>
<%
  if errOAI is None:
    #
%>
 <GetRecord>
<%
    req.write(lxmltostring(xpathFirst(oaigetrecord, '/oai:OAI-PMH/oai:GetRecord/oai:record')))
%>
 </GetRecord>
<%
  else:
    req.write(lxmltostring(errOAI))
  #
%>
</saharaget>
<%
else:
  import time
  include('/saharageterror?errorCode=' + errorCode)
%>
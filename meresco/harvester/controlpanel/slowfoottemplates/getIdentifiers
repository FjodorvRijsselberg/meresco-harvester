<%
domainId = args.domainId

stateDir = req.get_options()['stateDir']
from os.path import join, isfile
def listIds(repositoryId):
  idfile = join(stateDir, domainId, repositoryId + '.ids')
  if isfile(idfile):
    try:
      f = open(idfile)
      for id in map(str.strip, filter(None, f)):
%><identifier><%escape_xml(id)%></identifier>
<%
      #
    finally:
      f.close()
  #

repositoryGroupId = args.repositoryGroupId
groupIds = xpath(aslxml(url('/' + domainId + '.domain')).getroot(), 'repositoryGroupId/text()')
if not repositoryGroupId in groupIds:
  include('/saharageterror?errorCode=idDoesNotExist')
else:
  type('text/xml; charset=utf-8')
  repositoryIds = xpath(aslxml(url('/' + domainId + '.' + repositoryGroupId + '.repositoryGroup')).getroot(), 'repositoryId/text()')
%><?xml version="1.0" encoding="UTF-8"?>
<saharaget xmlns="http://sahara.cq2.org/xsd/saharaget.xsd">
<%
  include('/saharagetTime')
%> 
  <request>
    <verb>GetIdentifiers</verb>
    <domainId><% escape_xml(domainId) %></domainId>
    <repositoryGroupId><% escape_xml(repositoryGroupId) %></repositoryGroupId>
  </request>
  <GetIdentifiers>
<%
  for repositoryId in repositoryIds:
    listIds(repositoryId)
  #
%>
  </GetIdentifiers>
</saharaget>

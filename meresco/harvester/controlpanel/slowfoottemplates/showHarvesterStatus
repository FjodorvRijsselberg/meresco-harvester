<%
from lxml.etree import tostring
domainId = args.domainId
originalArgs = dict(domainId=domainId, repositoryGroupId=args.repositoryGroupId, repositoryId=args.repositoryId)
args = urlencode(originalArgs)
theUrl = url('/getStatus?%s' % args)
loggedIn = bool(session.get('username', ''))

statuses = xpath(aslxml(theUrl), '/sahara:saharaget/sahara:GetStatus/sahara:status')

statusUrl = url('%s/get?verb=GetStatus&%s' % (req.get_options()['internalServer'], args))
invalid = {}
for status in xpath(aslxml(statusUrl), '/sahara:saharaget/sahara:GetStatus/sahara:status'):
    invalid[xpathFirst(status, 'sahara:repositoryId/text()')] = status
#
%>
<p class="head">Harvester Status</p>
<p>Domain: <%=domainId%> <a href="/running.rss?<%= urlencode(dict(domainId=domainId)) %>"><img src="/images/rss.png"/></a></p>
<%
if originalArgs['repositoryGroupId']:
    %><p>RepositoryGroup: <%=originalArgs['repositoryGroupId']%></p><%
#
%>
<%
if originalArgs['repositoryId']:
    %><p>Repository: <%=originalArgs['repositoryId']%></p><%
#
%>
<table class="event">
<tr class="eventheader">
<td>RepositoryGroup</td>
<td>Repository</td>
<td>Last successful harvest</td>
<td>Total records</td>
<td>Harvested<br/>Uploaded<br/>Deleted</td>
<td>#Validation<br/>Errors</td>
<td>#Errors</td>
<td>RSS</td>
</tr>
<%
for status in sorted(statuses, key=lambda s: (xpathFirst(s, '@repositoryGroupId').lower(), xpathFirst(s, 'repositoryId'))):
  repositoryId = xpathFirst(status, '@repositoryId')
  repositoryGroupId = xpathFirst(status, '@repositoryGroupId')
  total = 0
  total += int(xpathFirst(status, 'sahara:total/text()') or '0')
  errorsnr = int(xpathFirst(status, 'sahara:totalerrors/text()'))
  style = errorsnr and 'style="font-weight:bold"' or ''
%>
<tr>
<td <%=style%> class="link"><%='<a href="/page/repositoryGroup.edit/%s.%s.repositoryGroup">' % (domainId, repositoryGroupId) if loggedIn else ''%><% escape_html(repositoryGroupId) %><%='</a>' if loggedIn else ''%></td>
<td <%=style%> class="link"><%='<a href="/page/repository.edit/%s.%s.repository?%s">' % (domainId, repositoryId, urlencode(dict(referrerGroup=repositoryGroupId))) if loggedIn else ''%><% escape_html(repositoryId) %><%='</a>' if loggedIn else ''%></td>
<td <%=style%>><% escape_html(xpathFirst(status, 'sahara:lastHarvestDate/text()') or '') %></td>
<td><% escape_html(xpathFirst(status, 'sahara:total/text()') or '') %></td>
<td><% escape_html(xpathFirst(status, 'sahara:harvested/text()') or '') %>/<% escape_html(xpathFirst(status, 'sahara:uploaded/text()') or '') %>/<% escape_html(xpathFirst(status, 'sahara:deleted/text()') or '') %></td>
<td class="link">
<%
  nrOfValidationErrors = int(xpathFirst(invalid[repositoryId], 'sahara:invalid/text()') or '') if repositoryId in invalid else 0
  args = urlencode(dict(domainId=domainId, repositoryId=repositoryId))
  if nrOfValidationErrors > 0:
%>
    <a href="/page/invalid/?<%= args %>"><%=nrOfValidationErrors%> error<%='s' if nrOfValidationErrors != 1 else ''%></a>
<%
  #
%>
</td>
<td class="error">
<%
  if errorsnr:
%>
    <a name="top_<%= status.repositoryId %>" href="#<%= status.repositoryId %>"><%=errorsnr%> error<%='s' if errorsnr != 1 else ''%></a>
<%
  #
%>
</td>
<td class="link">
<a href="/rss?<%= args %>"><img src="/images/rss.png"/></a>
</td>
</tr>
<%
#
%>
</table>
<br/>

<p class="head">Harvester Errors</p>
<table class="event">
<%
for status in statuses:
  repositoryId = xpathFirst(status, '@repositoryId')
  errorsnr = int(xpathFirst(status, 'sahara:totalerrors/text()') or '')
  if errorsnr:
    #
%>
<tr class="eventinfo">
<td><a name="<%= repositoryId %>" href="#top_<%= repositoryId %>"><%= repositoryId %></a></td>
<td>Last successful harvest</td>
<td><%= status.lastHarvestDate %></td>
</tr>
<tr>
<td>&nbsp;</td>
<td>Nr. of errors since:</td>
<td><b><%= errorsnr %></b></td>
</tr>
<%
    if hasattr(status.recenterrors, 'error'):
      for error in status.recenterrors.error:
        #
%>
  <tr class="eventerror">
    <td>&nbsp;</td>
    <td class="alt"><%= error.date %></td>
    <td class="alt"><% escape_html(error.split('|')[-1]) %></td>
  </tr>
<%
#
%>
</table>

<p class="head">Validatie Errors</p>
<table class="event">
<%
for status in statuses:
  repositoryId = xpathFirst(status, '@repositoryId')
  invalidnr = int(xpathFirst(status, 'sahara:invalid/text()') or '')
  if invalidnr:
    #
%>
<tr class="eventinfo">
<td><a name="<%= repositoryId %>" href="#top_<%= repositoryId %>"><%= repositoryId %></a></td>
</tr>
<tr>
<td>Nr. of validation errors: <strong><%= invalidnr %></strong></td>
</tr>
<%
    invalidIds = xpath(status, 'sahara:recentinvalids/sahara:invalidId')
    for invalidId in invalidIds:
      recordId = invalidId.split(":", 1)[-1]
      newArgs = {'recordId': recordId, 'repositoryId': repositoryId, 'domainId': domainId}
      #
%>
      <tr>
        <td class="link">
          <a href="/page/invalidRecord/?<%= urlencode(newArgs)%>"><%= recordId%></a>
        </td>
      </tr>
<%
#
%>
</table>
